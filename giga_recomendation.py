import requests
import json
from datetime import datetime
import os
from docx import Document
import pandas as pd


class MeetingAnalyzer:
    def __init__(self, auth_key, scope, api_auth_url, api_chat_url):
        self.auth_key = auth_key
        self.scope = scope
        self.api_auth_url = api_auth_url
        self.api_chat_url = api_chat_url
        self.access_token = None
        self.token_expires = 0

    def get_access_token(self):
        headers = {
            'Authorization': f'Bearer {self.auth_key}',
            'RqUID': '6f0b1291-c7f3-43c6-bb2e-9f3efb2dc98e',
            'Content-Type': 'application/x-www-form-urlencoded'
        }
        data = {'scope': self.scope}

        response = requests.post(self.api_auth_url, headers=headers, data=data, verify=False)
        if response.status_code == 200:
            token_data = response.json()
            self.access_token = token_data['access_token']
            self.token_expires = datetime.now().timestamp() + int(token_data['expires_at'])
            return True
        else:
            print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: {response.status_code} - {response.text}")
            return False

    def is_token_valid(self):
        return self.access_token and datetime.now().timestamp() < self.token_expires

    def read_docx(self, file_path):
        """–ß—Ç–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞ .docx"""
        if not os.path.exists(file_path):
            raise FileNotFoundError(f"–§–∞–π–ª {file_path} –Ω–µ –Ω–∞–π–¥–µ–Ω")

        doc = Document(file_path)
        full_text = []
        for para in doc.paragraphs:
            full_text.append(para.text)
        return '\n'.join(full_text)

    def _load_triggers_courses(self, triggers_file_path):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫—É—Ä—Å—ã –∏–∑ —Ñ–∞–π–ª–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤"""
        try:
            df = pd.read_excel(triggers_file_path)
            df = df.fillna('')
            
            courses_dict = {}
            for _, row in df.iterrows():
                comp = row.get('–∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è', '').strip()
                indicator = row.get('–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)', '').strip()
                courses = row.get('–∫—É—Ä—Å—ã', '').strip()
                
                if comp and courses:
                    key = f"{comp} - {indicator}" if indicator else comp
                    course_list = [c.strip() for c in courses.split(',') if c.strip()]
                    if course_list:
                        courses_dict[key] = course_list
            
            return courses_dict
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤ –∏–∑ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: {e}")
            return {}

    def _extract_competencies_from_report(self, report_text):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ —Å –Ω–∏–∑–∫–∏–º–∏ –±–∞–ª–ª–∞–º–∏ –∏–∑ –æ—Ç—á–µ—Ç–∞"""
        low_score_competencies = []
        lines = report_text.split('\n')
        
        for line in lines:
            # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è–º–∏ (—Å —ç–º–æ–¥–∑–∏ –∏–ª–∏ –±–µ–∑)
            if ('üî¥' in line or 'üü°' in line or 'üü¢' in line) and '**' in line:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏
                comp_name = line.split('**')[1].split('**')[0]
                low_score_competencies.append(comp_name)
            # –¢–∞–∫–∂–µ –∏—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å "üèÜ" (–∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π)
            elif 'üèÜ' in line and ' - —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª' in line:
                comp_name = line.split('üèÜ')[1].split(' - —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª')[0].strip()
                low_score_competencies.append(comp_name)
        
        return low_score_competencies

    def analyze_meeting(self):
        if not self.is_token_valid() and not self.get_access_token():
            return "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞"

        # –ß—Ç–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤—Å—Ç—Ä–µ—á–∏ –∏–∑ —Ñ–∞–π–ª–∞
        try:
            trans = self.read_docx('./trans.docx')
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {str(e)}"

        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –≤—Å—Ç—Ä–µ—á–∏ –∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:

–ò—Ç–æ–≥–∏ –ú–ú

–¢–≤–æ–π –≥–æ–ª–æ—Å –∏ —Ä–µ—á—å –±—ã–ª–∏ [–ø–æ–∑–∏—Ç–∏–≤–Ω—ã/–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã/–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã], [–¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã/—Ñ–æ—Ä–º–∞–ª—å–Ω—ã/—Ö–æ–ª–æ–¥–Ω—ã], [—Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—â–∏–µ –∫ –û–°/–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ/–æ—Ç—Ç–∞–ª–∫–∏–≤–∞—é—â–∏–µ]. 
–¢—ã –≤–æ–≤–ª—ë–∫ –≤ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ [N] –∏–∑ [M] –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ú–ú–ö. 
–¢—ã [–ø—Ä–æ–ø—É—Å—Ç–∏–ª/–Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏–ª] –≤–∞–∂–Ω—ã–π —ç—Ç–∞–ø - [–Ω–µ –æ–∑–≤—É—á–∏–ª –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ú–ú/–æ–∑–≤—É—á–∏–ª –ø—Ä–∞–≤–∏–ª–∞]/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º –≤–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –æ–±—É—á–µ–Ω–∏—è. 
–í –º–æ–º–µ–Ω—Ç –æ–±—Å—É–∂–¥–µ–Ω–∏—è [–Ω–µ –æ–∑–≤—É—á–∏–≤–∞–ª–∏—Å—å/–æ–∑–≤—É—á–∏–≤–∞–ª–∏—Å—å] –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞, —ç—Ç–æ [—Ö–æ—Ä–æ—à–æ/–ø–ª–æ—Ö–æ], –ö–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ. 
[–°–æ–±–ª—é–¥—ë–Ω —Ç–∞–π–º–∏–Ω–≥/–ù–µ —Å–æ–±–ª—é–¥—ë–Ω, –ø–æ—Ç—Ä–µ–Ω–∏—Ä—É–π—Å—è –∫–æ—Ä–æ—á–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –º—ã—Å–ª–∏]. 
[–û–¥–∏–Ω/–ù–µ—Å–∫–æ–ª—å–∫–æ/–ù–∏–∫—Ç–æ] –∏–∑ [M] —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ú–ú–ö [–§–ò–û] –ø–æ–≥—Ä—É–∑–∏–ª—Å—è –≤ –±–∏–∑–Ω–µ—Å –∫–ª–∏–µ–Ω—Ç–∞, –µ–≥–æ –∑–∞–¥–∞—á–∏ –∏ –ø–ª–∞–Ω—ã. 
–ü—Ä–∏ —ç—Ç–æ–º [–Ω–µ –ø–æ–≥—Ä—É–∑–∏–ª—Å—è/–ø–æ–≥—Ä—É–∑–∏–ª—Å—è] –≤ –∫–ª–∏–µ–Ω—Ç–∞, –Ω–µ —É–∑–Ω–∞–ª –æ –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö –∏ —Ö–æ–±–±–∏. 
–£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ –∫–ª–∏–µ–Ω—Ç–µ –∑–∞–¥–∞–≤–∞–ª–∏ [N] –∏–∑ [M] –ú–ú–ö. 
–¢—ã [–Ω–µ –ø—Ä–µ–¥–ª–æ–∂–∏–ª/–ø—Ä–µ–¥–ª–æ–∂–∏–ª] –∫–æ–º–∞–Ω–¥–µ –ø–æ–∏—Å–∫ —Ä–µ—à–µ–Ω–∏—è, —á—Ç–æ [–Ω–µ –ø–æ–∑–≤–æ–ª–∏–ª–æ/–ø–æ–∑–≤–æ–ª–∏–ª–æ] —Ç–µ–±–µ –≤–æ–≤–ª–µ—á—å –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. 
–ü—Ä–∏ —ç—Ç–æ–º —Ç–æ–±–æ–π [–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å —Å–ª–æ–≤–∞ –ø–∞—Ä–∞–∑–∏—Ç—ã (–±–æ–ª–µ–µ 3 —Ä–∞–∑)/–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å–ª–æ–≤–∞ –ø–∞—Ä–∞–∑–∏—Ç—ã (–±–æ–ª–µ–µ 3 —Ä–∞–∑)]. 
–¢—ã [–ø–µ—Ä–µ–±–∏–≤–∞–ª/–Ω–µ –ø–µ—Ä–µ–±–∏–≤–∞–ª] —Ä–µ—á—å [–§–ò–û]. 
–í –∏—Ç–æ–≥–µ [—Ä–µ–±—è—Ç–∞ –Ω–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–ª–∏ —Å–≤–æ—é –∏–¥–µ—é/–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è/—Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–ª–∏ —Å–≤–æ–∏ –∏–¥–µ–∏]. 
[–ë—ã–ª–∏/–ù–µ –±—ã–ª–æ] –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ª—É—à–∞–Ω–∏—è. 
–ü–æ –∏—Ç–æ–≥–∞–º –ú–ú [N] –∏–∑ [M] —Ä–µ–±—è—Ç –Ω–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–ª–∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å –≤—Å—Ç—Ä–µ—á–∏. –ò –Ω–µ –ø–æ–¥–µ–ª–∏–ª–∏—Å—å —Å–≤–æ–∏–º–∏ –º—ã—Å–ª—è–º–∏.

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –†–ú

–¢–µ–±–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

1. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1]
2. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2]
3. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3]
4. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 4]

–¢–µ–∫—Å—Ç –≤—Å—Ç—Ä–µ—á–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
{trans}"""

        return self._send_request(prompt)

    def _compress_text(self, text, max_length=500):
        """–°–∂–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç, —É–±–∏—Ä–∞—è –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã"""
        # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã
        compressed = ' '.join(text.split())
        if len(compressed) > max_length:
            compressed = compressed[:max_length] + "..."
        return compressed

    def _send_request(self, prompt):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ GigaChat API"""
        headers = {
            'Authorization': f'Bearer {self.access_token}',
            'Content-Type': 'application/json'
        }

        payload = {
            "model": "GigaChat",
            "messages": [
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            "temperature": 0.7,
            "top_p": 0.9,
            "n": 1,
            "stream": False,
            "max_tokens": 200000,
            "repetition_penalty": 1.0
        }

        response = requests.post(self.api_chat_url, headers=headers, json=payload, verify=False)
        if response.status_code == 200:
            result = response.json()
            return result['choices'][0]['message']['content']
        else:
            return f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å—Ç—Ä–µ—á–∏: {response.status_code} - {response.text}"

    def _extract_competencies_with_scores(self, report_text):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ —Å –±–∞–ª–ª–∞–º–∏ –∏–∑ –æ—Ç—á–µ—Ç–∞"""
        competencies_with_scores = {}
        lines = report_text.split('\n')
        
        print(f"DEBUG: –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ –æ—Ç—á–µ—Ç–µ: {len(lines)}")
        found_count = 0
        
        for i, line in enumerate(lines):
            # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å "üèÜ" (–∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π –≤ –¥–µ—Ç–∞–ª—å–Ω–æ–º –æ—Ç—á—ë—Ç–µ)
            if 'üèÜ' in line and ' - —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª' in line:
                found_count += 1
                print(f"DEBUG: –ù–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ {i}: {line}")
                comp_name = line.split('üèÜ')[1].split(' - —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª')[0].strip()
                # –ò—â–µ–º –±–∞–ª–ª –ø–æ—Å–ª–µ "—Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª"
                score_match = line.split('—Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª')[1].split()[0]
                try:
                    score = float(score_match)
                    competencies_with_scores[comp_name] = score
                    print(f"DEBUG: –ù–∞–π–¥–µ–Ω–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è '{comp_name}' —Å –±–∞–ª–ª–æ–º {score}")
                except:
                    print(f"DEBUG: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –±–∞–ª–ª –∏–∑ —Å—Ç—Ä–æ–∫–∏: {line}")
                    pass
        
        print(f"DEBUG: –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ —Å üèÜ: {found_count}")
        print(f"DEBUG: –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π —Å –±–∞–ª–ª–∞–º–∏: {len(competencies_with_scores)}")
        print(f"DEBUG: –ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏: {competencies_with_scores}")
        return competencies_with_scores

    def analyze_meeting_with_file(self, file_path=None, user_id=None):
        """–ê–Ω–∞–ª–∏–∑ –≤—Å—Ç—Ä–µ—á–∏ —Å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º —Ñ–∞–π–ª–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)"""
        # –ï—Å–ª–∏ file_path –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω ‚Äî –∏—â–µ–º trans.docx –≤ temp_files/{user_id}/trans.docx
        if file_path is None:
            if user_id is None:
                return "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏ user_id."
            file_path = f"temp_files/{user_id}/trans.docx"
        if not self.is_token_valid() and not self.get_access_token():
            return "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞"

        # –ß—Ç–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤—Å—Ç—Ä–µ—á–∏ –∏–∑ —Ñ–∞–π–ª–∞
        try:
            trans = self.read_docx(file_path)
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {str(e)}"

        if not self.is_token_valid() and not self.get_access_token():
            return "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞"


        # –ß–∏—Ç–∞–µ–º –æ—Ç—á–µ—Ç –ø–æ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è–º (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
        competency_report = ""
        try:
            if os.path.exists('REPORT.txt'):
                with open('REPORT.txt', 'r', encoding='utf-8') as f:
                    full_report = f.read()
                    print(f"DEBUG: –†–∞–∑–º–µ—Ä REPORT.txt: {len(full_report)} —Å–∏–º–≤–æ–ª–æ–≤")
                    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –æ—Ç—á–µ—Ç–∞ (–º–∞–∫—Å–∏–º—É–º 1000000 —Å–∏–º–≤–æ–ª–æ–≤)
                    if len(full_report) > 1000000:
                        competency_report = full_report[:1000000] + "\n\n[–û—Ç—á–µ—Ç –æ–±—Ä–µ–∑–∞–Ω –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞]"
                        print(f"DEBUG: –û—Ç—á–µ—Ç –æ–±—Ä–µ–∑–∞–Ω –¥–æ 1000000 —Å–∏–º–≤–æ–ª–æ–≤")
                    else:
                        competency_report = full_report
                        print(f"DEBUG: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç")
                print(f"DEBUG: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–π–ª: REPORT.txt")
            else:
                return "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª REPORT.txt –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π."
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π: {str(e)}"

        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—É—Ä—Å—ã –∏–∑ —Ñ–∞–π–ª–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
        triggers_file_path = 'triggers.xlsx'
        if not os.path.exists(triggers_file_path):
            return "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª triggers.xlsx –Ω–µ –Ω–∞–π–¥–µ–Ω."
        
        courses_dict = self._load_triggers_courses(triggers_file_path)
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ –∏ –±–∞–ª–ª–∞–º–∏ –∏–∑ –æ—Ç—á–µ—Ç–∞
        problem_competencies = self._extract_competencies_from_report(competency_report)
        competencies_with_scores = self._extract_competencies_with_scores(competency_report)
        
        # –°–∂–∏–º–∞–µ–º –æ—Ç—á–µ—Ç –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞
        competency_report = self._compress_text(competency_report, 600)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –∫—É—Ä—Å–∞–º–∏
        courses_text = ""
        if courses_dict and problem_competencies:
            courses_text = "\n\nüìö –î–û–°–¢–£–ü–ù–´–ï –ö–£–†–°–´ –î–õ–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô:\n"
            for comp in problem_competencies:
                # –ò—â–µ–º –∫—É—Ä—Å—ã –¥–ª—è —ç—Ç–æ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏
                for key, courses in courses_dict.items():
                    if comp.lower() in key.lower():
                        courses_text += f"- {comp}:\n"
                        for course in courses:
                            courses_text += f"  ‚Ä¢ {course}\n"
                        break

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å —Ç–æ—á–Ω—ã–º–∏ –±–∞–ª–ª–∞–º–∏
        scores_text = ""
        if competencies_with_scores:
            scores_text = "\n\nüìä –¢–û–ß–ù–´–ï –ë–ê–õ–õ–´ –ò–ó –û–¢–ß–Å–¢–ê:\n"
            for comp, score in competencies_with_scores.items():
                scores_text += f"- {comp}: {score}/10\n"

        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        print(f"DEBUG: –ù–∞–π–¥–µ–Ω–æ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π —Å –±–∞–ª–ª–∞–º–∏: {len(competencies_with_scores)}")
        print(f"DEBUG: –ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏: {list(competencies_with_scores.keys())}")
        print(f"DEBUG: –ö—É—Ä—Å—ã: {courses_text}")
        print(f"DEBUG: –ë–∞–ª–ª—ã: {scores_text}")

        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –≤—Å—Ç—Ä–µ—á–∏ –∏ –æ—Ç—á–µ—Ç –ø–æ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è–º, –∑–∞—Ç–µ–º —Å—Ñ–æ—Ä–º–∏—Ä—É–π –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

# –î–ï–¢–ê–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –†–ê–ó–í–ò–¢–ò–Æ

## –ê–Ω–∞–ª–∏–∑ –≤—Å—Ç—Ä–µ—á–∏ –∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π

[–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è, —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤—Å—Ç—Ä–µ—á–∏, –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤]

## –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ö–û–ú–ü–ï–¢–ï–ù–¶–ò–Ø–ú

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è:

{courses_text}

{scores_text}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∫—É—Ä—Å—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã–µ –∫—É—Ä—Å—ã. –ï—Å–ª–∏ –¥–ª—è –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ –Ω–µ—Ç –∫—É—Ä—Å–æ–≤ –≤ —Å–ø–∏—Å–∫–µ, –Ω–µ —É–∫–∞–∑—ã–≤–∞–π –∫—É—Ä—Å—ã –≤–æ–æ–±—â–µ.

–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–ß–ù–´–ï –ë–ê–õ–õ–´ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ. –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –±–∞–ª–ª—ã.

–î–õ–Ø –ö–ê–ñ–î–û–ô –ö–û–ú–ü–ï–¢–ï–ù–¶–ò–ò –î–û–ë–ê–í–¨ –†–ê–ó–î–ï–õ "üí¨ –ö–û–ù–°–¢–†–£–ö–¢–ò–í–ù–´–ï –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–´":
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Ñ—Ä–∞–∑—ã –∏–∑ –æ—Ç—á—ë—Ç–∞
- –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- –§–æ—Ä–º–∞—Ç: "–í–º–µ—Å—Ç–æ: [–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è —Ñ—Ä–∞–∑–∞] ‚Üí –ú–æ–≥ –±—ã —Å–∫–∞–∑–∞—Ç—å: [–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞]"

–°–û–ó–î–ê–ô –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –í–°–ï–• –ö–û–ú–ü–ï–¢–ï–ù–¶–ò–ô –ò–ó –°–ü–ò–°–ö–ê –í–´–®–ï:

–í–ê–ñ–ù–û: –°–æ–∑–¥–∞–π –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –ö–ê–ñ–î–û–ô –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –±–∞–ª–ª–æ–≤ –≤—ã—à–µ. –ù–ï –ø—Ä–æ–ø—É—Å–∫–∞–π –Ω–∏ –æ–¥–Ω–æ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏.

[–î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–π –±–ª–æ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:]

**[–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏]** - [–¢–û–ß–ù–´–ô –ë–ê–õ–õ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ]
- üìä **–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å:** [–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è]
- üìö **–ö—É—Ä—Å—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è:**
  - [–ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∫—É—Ä—Å—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å]
- üí° **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
  - [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1]
  - [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2]
- üí¨ **–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**
  - –í–º–µ—Å—Ç–æ: [–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è —Ñ—Ä–∞–∑–∞] ‚Üí –ú–æ–≥ –±—ã —Å–∫–∞–∑–∞—Ç—å: [–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞]
  - –í–º–µ—Å—Ç–æ: [–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è —Ñ—Ä–∞–∑–∞] ‚Üí –ú–æ–≥ –±—ã —Å–∫–∞–∑–∞—Ç—å: [–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞]
- üéØ **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** [–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ä–∞–∑–≤–∏—Ç–∏—è]

## –û–ë–©–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –í–°–¢–†–ï–ß–ï

### –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å –≤ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –≤—Å—Ç—Ä–µ—á:

1. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≤—Å—Ç—Ä–µ—á–∏]
2. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏]
3. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –≤–æ–≤–ª–µ—á–µ–Ω–∏—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤]

## –ü–õ–ê–ù –†–ê–ó–í–ò–¢–ò–Ø –ù–ê –ë–õ–ò–ñ–ê–ô–®–ò–ô –ú–ï–°–Ø–¶

### –ù–µ–¥–µ–ª—è 1: [–§–æ–∫—É—Å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—é]
- [–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è]
- [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è]

### –ù–µ–¥–µ–ª—è 2: [–§–æ–∫—É—Å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—é]
- [–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è]
- [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è]

---

–¢–µ–∫—Å—Ç –≤—Å—Ç—Ä–µ—á–∏:
{trans}

–ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç –ø–æ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è–º:
{competency_report}
"""

        return self._send_request(prompt)


# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    AUTH_KEY = 'ZGMzMGJmZjEtODQwYS00ZjAwLWI2NjgtNGIyNGNiY2ViNmE1OjYwNjM3NTU0LWQxMDctNDA5ZS1hZWM3LTAwYjQ5MjZkOGU2OA=='
    SCOPE = 'GIGACHAT_API_PERS'
    API_AUTH_URL = 'https://ngw.devices.sberbank.ru:9443/api/v2/oauth'
    API_CHAT_URL = 'https://gigachat.devices.sberbank.ru/api/v1/chat/completions'

    analyzer = MeetingAnalyzer(AUTH_KEY, SCOPE, API_AUTH_URL, API_CHAT_URL)

    try:
        analysis_result = analyzer.analyze_meeting()
        print("–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤—Å—Ç—Ä–µ—á–∏:")
        print(analysis_result)

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ —Ñ–∞–π–ª
        with open('meeting_analysis.txt', 'w', encoding='utf-8') as f:
            f.write(analysis_result)
        print("\n–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ñ–∞–π–ª meeting_analysis.txt")

    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}")